<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³æ‹¼å†™ç”Ÿè¯æœ¬</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 25px 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        h2 { margin-top: 0; font-size: 20px; color: #2c3e50; display: flex; justify-content: space-between; align-items: center;}
        
        #recordBtn { background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; user-select: none; transition: all 0.2s; width: 100%; box-shadow: 0 4px 6px rgba(0,123,255,0.3); -webkit-touch-callout: none; }
        #recordBtn:active, #recordBtn.recording { background: #dc3545; box-shadow: 0 2px 4px rgba(220,53,69,0.3); transform: translateY(2px); }
        
        #exportBtn { background: #28a745; color: white; border: none; padding: 8px 15px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        #exportBtn:hover { background: #218838; }

        .status { margin-top: 15px; font-size: 14px; color: #888; height: 20px; }
        #resultWord { font-size: 36px; font-weight: bold; margin: 15px 0; color: #2c3e50; letter-spacing: 2px; }
        #meaning { font-size: 15px; color: #555; min-height: 45px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        
        .input-group { text-align: left; margin-bottom: 15px; }
        label { font-size: 14px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        .word-list { text-align: left; }
        .archive-group { margin-top: 20px; }
        .archive-header { background: #e9ecef; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 14px; color: #495057; display: flex; justify-content: space-between; }
        .word-item { padding: 12px 10px; border-bottom: 1px solid #eee; }
        .word-item:last-child { border-bottom: none; }
        .word-word { font-size: 18px; font-weight: bold; color: #007bff; }
        .word-meaning { font-size: 14px; color: #666; margin-top: 4px; display: block; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ™ï¸ æŒ‰ä½è¯»å­—æ¯æ‹¼å†™</h2>
        
        <div class="input-group">
            <label for="archiveName">å½’æ¡£åç§° (å¯ä¿®æ”¹ä¸ºä¹¦å/ç« èŠ‚):</label>
            <input type="text" id="archiveName" placeholder="ä¾‹å¦‚: 2026-02-20 æˆ– ç®€çˆ±-ç¬¬ä¸€ç« ">
        </div>

        <button id="recordBtn">æŒ‰ä½å¼€å§‹æ‹¼å†™å­—æ¯</button>
        <div class="status" id="statusText">å‡†å¤‡å°±ç»ª...</div>
        
        <div id="resultWord">...</div>
        <div id="meaning">ç­‰å¾…æŸ¥è¯...</div>
    </div>

    <div class="card word-list">
        <h2>
            ğŸ“š ä½ çš„ç”Ÿè¯æœ¬
            <button id="exportBtn">ğŸ’¾ å¯¼å‡º CSV</button>
        </h2>
        <div id="vocabList"></div>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸä½œä¸ºé»˜è®¤å½’æ¡£å
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('archiveName').value = today;

        const recordBtn = document.getElementById('recordBtn');
        const exportBtn = document.getElementById('exportBtn');
        const statusText = document.getElementById('statusText');
        const resultWordDisplay = document.getElementById('resultWord');
        const meaningDisplay = document.getElementById('meaning');
        const vocabListDisplay = document.getElementById('vocabList');

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ« (ä½¿ç”¨è‹±æ–‡è¯†åˆ«ä»¥ç¡®ä¿å­—æ¯å‡†ç¡®åº¦)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                statusText.innerText = "æ­£åœ¨è†å¬å­—æ¯ (ä¾‹å¦‚è¯» 'A P P L E')...";
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                const word = transcript.replace(/\s+/g, '').toLowerCase();
                
                resultWordDisplay.innerText = word;
                statusText.innerText = "æ­£åœ¨æŸ¥è¯¢æ„æ€...";
                meaningDisplay.innerText = "æŸ¥è¯¢ä¸­...";

                await processWord(word);
            };

            recognition.onerror = (event) => {
                statusText.innerText = "è¯†åˆ«å‡ºé”™: " + event.error + "ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚";
            };

            recognition.onend = () => {
                recordBtn.classList.remove('recording');
                recordBtn.innerText = "æŒ‰ä½å¼€å§‹æ‹¼å†™å­—æ¯";
            };
        } else {
            statusText.innerText = "ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeã€‚";
            recordBtn.disabled = true;
        }

        const startRecording = (e) => {
            e.preventDefault();
            if(!recognition) return;
            recordBtn.classList.add('recording');
            recordBtn.innerText = "æ¾å¼€ç»“æŸå¹¶ç¡®è®¤...";
            recognition.start();
        };

        const stopRecording = (e) => {
            e.preventDefault();
            if(!recognition) return;
            recognition.stop();
        };

        recordBtn.addEventListener('mousedown', startRecording);
        recordBtn.addEventListener('mouseup', stopRecording);
        recordBtn.addEventListener('touchstart', startRecording);
        recordBtn.addEventListener('touchend', stopRecording);

        // å¤„ç†å•è¯ï¼šæŸ¥è¯¢é‡Šä¹‰å¹¶ä¿å­˜
        async function processWord(word) {
            if (!/^[a-z]+$/.test(word)) {
                meaningDisplay.innerText = "æœªè¯†åˆ«å‡ºçº¯å­—æ¯æ„æˆçš„å•è¯ï¼Œè¯·ç¡®ä¿è¯»éŸ³æ¸…æ™°ã€‚";
                return;
            }

            let meaning = "æš‚æ— é‡Šä¹‰ï¼Œå¯èƒ½æ‹¼å†™æœ‰è¯¯æˆ–å­—å…¸æœªæ”¶å½•ã€‚";
            
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (response.ok) {
                    const data = await response.json();
                    meaning = data[0].meanings[0].definitions[0].definition;
                }
            } catch (error) {
                console.error(error);
                meaning = "ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–é‡Šä¹‰ã€‚";
            }

            meaningDisplay.innerText = meaning;
            saveWord(word, meaning);
            renderVocabList();
        }

        // ä¿å­˜å•è¯åˆ° LocalStorage
        function saveWord(word, meaning) {
            const archiveName = document.getElementById('archiveName').value || today;
            let vocabData = JSON.parse(localStorage.getItem('myVocabBook')) || {};
            
            if (!vocabData[archiveName]) {
                vocabData[archiveName] = [];
            }
            
            const exists = vocabData[archiveName].find(w => w.word === word);
            if (!exists) {
                vocabData[archiveName].unshift({ word, meaning });
                localStorage.setItem('myVocabBook', JSON.stringify(vocabData));
            }
        }

        // æ¸²æŸ“ç”Ÿè¯åˆ—è¡¨
        function renderVocabList() {
            const vocabData = JSON.parse(localStorage.getItem('myVocabBook')) || {};
            vocabListDisplay.innerHTML = '';

            for (const archive in vocabData) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'archive-group';
                
                const header = document.createElement('div');
                header.className = 'archive-header';
                header.innerHTML = `<span>ğŸ“‚ ${archive}</span> <span>${vocabData[archive].length} è¯</span>`;
                groupDiv.appendChild(header);

                vocabData[archive].forEach(item => {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'word-item';
                    wordDiv.innerHTML = `
                        <span class="word-word">${item.word}</span>
                        <span class="word-meaning">${item.meaning}</span>
                    `;
                    groupDiv.appendChild(wordDiv);
                });

                vocabListDisplay.appendChild(groupDiv);
            }
        }

        // å¯¼å‡ºä¸º CSV åŠŸèƒ½
        exportBtn.addEventListener('click', () => {
            const vocabData = JSON.parse(localStorage.getItem('myVocabBook')) || {};
            if (Object.keys(vocabData).length === 0) {
                alert("ç”Ÿè¯æœ¬æ˜¯ç©ºçš„ï¼Œå…ˆå»å½•å…¥å‡ ä¸ªå•è¯å§ï¼");
                return;
            }

            // æ·»åŠ  BOM å¤´éƒ¨ï¼Œé˜²æ­¢ Excel æ‰“å¼€æ—¶ä¸­æ–‡ä¹±ç 
            let csvContent = "\uFEFFå½’æ¡£åç§°,å•è¯,é‡Šä¹‰\n";

            for (const archive in vocabData) {
                vocabData[archive].forEach(item => {
                    // å¤„ç†é‡Šä¹‰ä¸­å¯èƒ½åŒ…å«çš„åŒå¼•å·ï¼Œå¹¶ç”¨åŒå¼•å·åŒ…è£¹æ¯ä¸ªå­—æ®µï¼Œé˜²æ­¢é€—å·ç ´åæ ¼å¼
                    let safeMeaning = item.meaning.replace(/"/g, '""');
                    csvContent += `"${archive}","${item.word}","${safeMeaning}"\n`;
                });
            }

            // åˆ›å»º Blob å¹¶è§¦å‘ä¸‹è½½
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `ç”Ÿè¯æœ¬_${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // åˆå§‹åŒ–æ¸²æŸ“
        renderVocabList();
    </script>
</body>
</html>
