<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³æ‹¼å†™ç”Ÿè¯æœ¬</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 25px 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        h2 { margin-top: 0; font-size: 20px; color: #2c3e50; display: flex; justify-content: space-between; align-items: center;}
        
        #recordBtn { background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; user-select: none; transition: all 0.2s; width: 100%; box-shadow: 0 4px 6px rgba(0,123,255,0.3); -webkit-touch-callout: none; }
        /* ä¿®æ”¹äº†æŒ‰é’®ç‚¹å‡»çŠ¶æ€çš„æ•ˆæœ */
        #recordBtn:active { transform: translateY(2px); }
        #recordBtn.recording { background: #dc3545; box-shadow: 0 2px 4px rgba(220,53,69,0.3); animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220,53,69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220,53,69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220,53,69, 0); }
        }

        #exportBtn { background: #28a745; color: white; border: none; padding: 8px 15px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        #exportBtn:hover { background: #218838; }

        .status { margin-top: 15px; font-size: 14px; color: #888; height: 20px; }
        #resultWord { font-size: 36px; font-weight: bold; margin: 15px 0; color: #2c3e50; letter-spacing: 2px; }
        #meaning { font-size: 15px; color: #555; min-height: 45px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        
        .input-group { text-align: left; margin-bottom: 15px; }
        label { font-size: 14px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        .word-list { text-align: left; }
        .archive-group { margin-top: 20px; }
        .archive-header { background: #e9ecef; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 14px; color: #495057; display: flex; justify-content: space-between; }
        .word-item { padding: 12px 10px; border-bottom: 1px solid #eee; }
        .word-item:last-child { border-bottom: none; }
        .word-word { font-size: 18px; font-weight: bold; color: #007bff; }
        .word-meaning { font-size: 14px; color: #666; margin-top: 4px; display: block; }
    </style>
</head>
<body>

    <div class="card">
        <!-- æ ‡é¢˜ä¹Ÿæ”¹æˆäº†ç‚¹å‡» -->
        <h2>ğŸ™ï¸ ç‚¹å‡»è¯»å­—æ¯æ‹¼å†™</h2>
        
        <div class="input-group">
            <label for="archiveName">å½’æ¡£åç§° (å¯ä¿®æ”¹ä¸ºä¹¦å/ç« èŠ‚):</label>
            <input type="text" id="archiveName" placeholder="ä¾‹å¦‚: 2026-02-20 æˆ– ç®€çˆ±-ç¬¬ä¸€ç« ">
        </div>

        <button id="recordBtn">ğŸ™ï¸ ç‚¹å‡»å¼€å§‹æ‹¼å†™å­—æ¯</button>
        <div class="status" id="statusText">å‡†å¤‡å°±ç»ª...</div>
        
        <div id="resultWord">...</div>
        <div id="meaning">ç­‰å¾…æŸ¥è¯...</div>
    </div>

    <div class="card word-list">
        <h2>
            ğŸ“š ä½ çš„ç”Ÿè¯æœ¬
            <button id="exportBtn">ğŸ’¾ å¯¼å‡º CSV</button>
        </h2>
        <div id="vocabList"></div>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸä½œä¸ºé»˜è®¤å½’æ¡£å
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('archiveName').value = today;

        const recordBtn = document.getElementById('recordBtn');
        const exportBtn = document.getElementById('exportBtn');
        const statusText = document.getElementById('statusText');
        const resultWordDisplay = document.getElementById('resultWord');
        const meaningDisplay = document.getElementById('meaning');
        const vocabListDisplay = document.getElementById('vocabList');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        // æ ¸å¿ƒä¿®å¤ï¼šå°†è¯†åˆ«é€»è¾‘å°è£…æˆå‡½æ•°ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½åˆ›å»ºä¸€ä¸ªã€å…¨æ–°ã€‘çš„è¯†åˆ«å®ä¾‹
        function startRecognition() {
            if (!SpeechRecognition) {
                statusText.innerText = "ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Safari æˆ– Chromeã€‚";
                return;
            }

            // æ¯æ¬¡é‡æ–°å®ä¾‹åŒ–ï¼Œè§£å†³ iOS Safari è¿ç»­è¯†åˆ«å¡æ­»çš„é—®é¢˜
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.continuous = false; // iOS ä¸‹å¼ºçƒˆå»ºè®®è®¾ä¸º falseï¼Œè¯†åˆ«å®Œä¸€æ¬¡è‡ªåŠ¨åœ

            recognition.onstart = () => {
                isRecording = true;
                recordBtn.classList.add('recording');
                recordBtn.innerText = "ğŸ›‘ æ­£åœ¨è†å¬... ç‚¹å‡»ç»“æŸ";
                statusText.innerText = "è¯·è¯»å‡ºå­—æ¯ (ä¾‹å¦‚è¯» 'A P P L E')...";
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                // ä½¿ç”¨æ›´ä¸¥è°¨çš„æ­£ä¾§è¡¨è¾¾å¼ï¼šå»æ‰ç©ºæ ¼å’Œå¯èƒ½è¯†åˆ«å‡ºæ¥çš„æ ‡ç‚¹ç¬¦å·ï¼Œåªä¿ç•™çº¯å­—æ¯
                const word = transcript.replace(/[^a-zA-Z]/g, '').toLowerCase();
                
                resultWordDisplay.innerText = word;
                statusText.innerText = "æ­£åœ¨æŸ¥è¯¢æ„æ€...";
                meaningDisplay.innerText = "æŸ¥è¯¢ä¸­...";

                await processWord(word);
            };

            recognition.onerror = (event) => {
                console.error("è¯†åˆ«é”™è¯¯:", event.error);
                if (event.error === 'service-not-allowed') {
                    statusText.innerText = "è¯†åˆ«å‡ºé”™ã€‚è¯·ç¡®ä¿åœ¨è®¾ç½®ä¸­å¼€å¯äº†ã€å¯ç”¨å¬å†™ã€‘ã€‚";
                } else if (event.error === 'not-allowed') {
                    statusText.innerText = "æœªè·å¾—éº¦å…‹é£æƒé™ã€‚";
                } else if (event.error === 'no-speech') {
                    statusText.innerText = "æœªå¬åˆ°å£°éŸ³ï¼Œè¯·é‡è¯•ã€‚";
                } else {
                    statusText.innerText = "è¯†åˆ«å‡ºé”™: " + event.error + "ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚";
                }
            };

            recognition.onend = () => {
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordBtn.innerText = "ğŸ™ï¸ ç‚¹å‡»å¼€å§‹æ‹¼å†™å­—æ¯";
                // åªæœ‰åœ¨æ²¡æœ‰è¿›å…¥æŸ¥è¯¢æµç¨‹æ—¶ï¼Œæ‰å°†çŠ¶æ€é‡ç½®
                if(statusText.innerText.includes("è¯·è¯»å‡ºå­—æ¯")) {
                    statusText.innerText = "è¯†åˆ«å·²ç»“æŸã€‚";
                }
            };

            try {
                recognition.start();
            } catch (err) {
                console.error(err);
                isRecording = false;
                statusText.innerText = "å¯åŠ¨éº¦å…‹é£å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
            }
        }

        // ä¿®æ”¹äº¤äº’é€»è¾‘ä¸ºï¼šç‚¹å‡»å¼€å…³
        recordBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (isRecording && recognition) {
                recognition.stop(); // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œç‚¹å‡»åˆ™å¼ºåˆ¶ç»“æŸå¹¶è¯†åˆ«
            } else {
                startRecognition(); // å¦‚æœæ²¡å½•éŸ³ï¼Œç‚¹å‡»åˆ™å¼€å§‹
            }
        });

        // å¤„ç†å•è¯ï¼šæŸ¥è¯¢é‡Šä¹‰å¹¶ä¿å­˜
        async function processWord(word) {
            if (!word || !/^[a-z]+$/.test(word)) {
                meaningDisplay.innerText = "æœªè¯†åˆ«å‡ºçº¯å­—æ¯æ„æˆçš„å•è¯ï¼Œè¯·é‡è¯•ã€‚";
                statusText.innerText = "è¯†åˆ«å¤±è´¥";
                return;
            }

            let meaning = "æš‚æ— é‡Šä¹‰ï¼Œå¯èƒ½æ‹¼å†™æœ‰è¯¯æˆ–å­—å…¸æœªæ”¶å½•ã€‚";
            
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (response.ok) {
                    const data = await response.json();
                    meaning = data[0].meanings[0].definitions[0].definition;
                    statusText.innerText = "æŸ¥è¯¢æˆåŠŸï¼";
                } else {
                    statusText.innerText = "å­—å…¸æœªæ”¶å½•è¯¥è¯";
                }
            } catch (error) {
                console.error(error);
                meaning = "ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–é‡Šä¹‰ã€‚";
                statusText.innerText = "æŸ¥è¯¢å‡ºé”™";
            }

            meaningDisplay.innerText = meaning;
            saveWord(word, meaning);
            renderVocabList();
        }

        // ä¿å­˜å•è¯åˆ° LocalStorage
        function saveWord(word, meaning) {
            const archiveName = document.getElementById('archiveName').value || today;
            let vocabData = JSON.parse(localStorage.getItem('myVocabBook')) || {};
            
            if (!vocabData[archiveName]) {
                vocabData[archiveName] = [];
            }
            
            const exists = vocabData[archiveName].find(w => w.word === word);
            if (!exists) {
                vocabData[archiveName].unshift({ word, meaning });
                localStorage.setItem('myVocabBook', JSON.stringify(vocabData));
            }
        }

        // æ¸²æŸ“ç”Ÿè¯åˆ—è¡¨
        function renderVocabList() {
            const vocabData = JSON.parse(localStorage.getItem('myVocabBook')) || {};
            vocabListDisplay.innerHTML = '';

            for (const archive in vocabData) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'archive-group';
                
                const header = document.createElement('div');
                header.className = 'archive-header';
                header.innerHTML = `<span>ğŸ“‚ ${archive}</span> <span>${vocabData[archive].length} è¯</span>`;
                groupDiv.appendChild(header);

                vocabData[archive].forEach(item => {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'word-item';
                    wordDiv.innerHTML = `
                        <span class="word-word">${item.word}</span>
                        <span class="word-meaning">${item.meaning}</span>
                    `;
                    groupDiv.appendChild(wordDiv);
                });

                vocabListDisplay.appendChild(groupDiv);
            }
        }

        // å¯¼å‡ºä¸º CSV åŠŸèƒ½
        exportBtn.addEventListener('click', () => {
            const vocabData = JSON.parse(localStorage.getItem('myVocabBook')) || {};
            if (Object.keys(vocabData).length === 0) {
                alert("ç”Ÿè¯æœ¬æ˜¯ç©ºçš„ï¼Œå…ˆå»å½•å…¥å‡ ä¸ªå•è¯å§ï¼");
                return;
            }

            let csvContent = "\uFEFFå½’æ¡£åç§°,å•è¯,é‡Šä¹‰\n";

            for (const archive in vocabData) {
                vocabData[archive].forEach(item => {
                    let safeMeaning = item.meaning.replace(/"/g, '""');
                    csvContent += `"${archive}","${item.word}","${safeMeaning}"\n`;
                });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `ç”Ÿè¯æœ¬_${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // åˆå§‹åŒ–æ¸²æŸ“
        renderVocabList();
    </script>
</body>
</html>
